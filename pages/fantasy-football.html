<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="description" content="Fantasy Football League Dashboard - Team rankings, player stats, and weekly analysis">
    <meta name="keywords" content="fantasy football, premier league, FPL, football statistics, team rankings">
    <title>Fantasy Football League</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 15px;
            color: white;
        }

        .main-content {
            display: flex;
            justify-content: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .league-column {
            width: 100%;
            max-width: 800px;
        }

        .column {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .column h2 {
            margin-bottom: 15px;
            font-size: 1.4rem;
            text-align: center;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 8px;
        }

        .loading-message, .error-message {
            text-align: center;
            padding: 30px;
            font-size: 1rem;
        }

        .error-message {
            color: #ff6b6b;
        }

        .gameweek-info {
            text-align: center;
            background: rgba(255,255,255,0.05);
            padding: 6px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.8);
        }

        .position-movement {
            font-size: 0.75rem;
            margin-left: 4px;
        }

        .movement-up {
            color: #4CAF50;
        }

        .movement-down {
            color: #f44336;
        }

        .movement-same {
            color: #9E9E9E;
        }

        .league-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .league-table th,
        .league-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .league-table th {
            background: rgba(255,255,255,0.1);
            font-weight: bold;
        }

        .league-table tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .position-1 { color: #FFD700; font-weight: bold; }
        .position-2 { color: #C0C0C0; font-weight: bold; }
        .position-3 { color: #CD7F32; font-weight: bold; }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .league-table {
                font-size: 0.9rem;
            }
            
            .league-table th,
            .league-table td {
                padding: 8px 5px;
            }
            
            .position-movement {
                font-size: 0.7rem;
            }
        }
    </style>
</head>

<body>
    <main id="main-content" class="main-content">
        <!-- Single Column: League Table -->
        <div class="column league-column">
            <h2>‚öΩÔ∏è Fantasy Premier League üèÜ</h2>
            <div id="gameweekInfo" class="gameweek-info">
                <p>Loading gameweek information...</p>
            </div>
            
            <div id="loading" class="loading-message">
                <p>Loading league data...</p>
            </div>
            
            <div id="error" class="error-message" style="display: none;">
                <p>Unable to load league data. Please try again later.</p>
            </div>
            
            <table class="league-table" id="leagueTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Pos</th>
                        <th>Manager</th>
                        <th>Team Name</th>
                        <th>GW</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="leagueTableBody">
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </main>

    <script>
        // Fantasy Premier League API endpoints
        const LEAGUE_ID = 1509278;
        const FPL_API_BASE = 'https://fantasy.premierleague.com/api';
        
        // Proxy service to handle CORS (trying different proxies)
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://cors-anywhere.herokuapp.com/'
        ];
        let currentProxyIndex = 0;

        // Function to try different CORS proxies
        async function fetchWithProxy(url, proxyIndex = 0) {
            if (proxyIndex >= CORS_PROXIES.length) {
                throw new Error('All CORS proxies failed');
            }
            
            try {
                const proxy = CORS_PROXIES[proxyIndex];
                const proxyUrl = `${proxy}${encodeURIComponent(url)}`;
                console.log(`Trying proxy ${proxyIndex + 1}: ${proxy}`);
                
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.log(`Proxy ${proxyIndex + 1} failed:`, error);
                return fetchWithProxy(url, proxyIndex + 1);
            }
        }

        // Caching system for gameweek info
        const CACHE_KEY = 'fpl_gameweek_cache';
        const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds

        // Function to get cached gameweek info
        function getCachedGameweekInfo() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const data = JSON.parse(cached);
                    const now = Date.now();
                    if (now - data.timestamp < CACHE_DURATION) {
                        console.log('Using cached gameweek info:', data.info);
                        return data.info;
                    }
                }
            } catch (error) {
                console.log('Error reading cache:', error);
            }
            return null;
        }

        // Function to cache gameweek info
        function cacheGameweekInfo(info) {
            try {
                const cacheData = {
                    info: info,
                    timestamp: Date.now()
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
                console.log('Cached gameweek info:', info);
            } catch (error) {
                console.log('Error caching data:', error);
            }
        }

        // Function to fetch current gameweek information
        async function fetchGameweekInfo() {
            // First, try to load from cache
            const cachedInfo = getCachedGameweekInfo();
            if (cachedInfo) {
                document.getElementById('gameweekInfo').innerHTML = `<p>${cachedInfo}</p>`;
                return;
            }

            try {
                console.log('Fetching gameweek information from API...');
                const data = await fetchWithProxy(`${FPL_API_BASE}/bootstrap-static/`);
                console.log('Gameweek data received:', data);
                
                // Find current gameweek
                const currentGameweek = data.events.find(event => event.is_current) || 
                                       data.events.find(event => event.is_next) ||
                                       data.events[0];
                
                if (currentGameweek) {
                    console.log('Current gameweek:', currentGameweek);
                    const deadlineDate = new Date(currentGameweek.deadline_time);
                    const options = { 
                        weekday: 'short', 
                        day: 'numeric', 
                        month: 'short',
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false
                    };
                    const formattedDeadline = deadlineDate.toLocaleDateString('en-GB', options);
                    const gameweekText = `Gameweek ${currentGameweek.id} | Deadline: ${formattedDeadline}`;
                    
                    // Cache the successful result
                    cacheGameweekInfo(gameweekText);
                    
                    document.getElementById('gameweekInfo').innerHTML = `<p>${gameweekText}</p>`;
                } else {
                    document.getElementById('gameweekInfo').innerHTML = 
                        `<p>Gameweek information unavailable</p>`;
                }
            } catch (error) {
                console.error('Error fetching gameweek info:', error);
                // Try to use cached data even if it's older
                const oldCached = localStorage.getItem(CACHE_KEY);
                if (oldCached) {
                    try {
                        const data = JSON.parse(oldCached);
                        console.log('Using older cached data as fallback:', data.info);
                        document.getElementById('gameweekInfo').innerHTML = `<p>${data.info} (cached)</p>`;
                        return;
                    } catch (e) {
                        console.log('Error parsing old cache:', e);
                    }
                }
                
                // Show a clean message when gameweek info can't be loaded
                document.getElementById('gameweekInfo').innerHTML = 
                    `<p>Fantasy Premier League | League ${LEAGUE_ID}</p>`;
            }
        }

        // Function to fetch league standings
        async function fetchLeagueStandings() {
            try {
                console.log('Fetching league standings...');
                const data = await fetchWithProxy(`${FPL_API_BASE}/leagues-classic/${LEAGUE_ID}/standings/`);
                console.log('League data received:', data);
                
                displayLeagueTable(data.standings.results);
                
            } catch (error) {
                console.error('Error fetching league data:', error);
                showError();
            }
        }

        // Function to display the league table
        function displayLeagueTable(standings) {
            const tableBody = document.getElementById('leagueTableBody');
            const loadingElement = document.getElementById('loading');
            const tableElement = document.getElementById('leagueTable');
            
            // Hide loading message
            loadingElement.style.display = 'none';
            
            // Clear existing data
            tableBody.innerHTML = '';
            
            // Add standings data
            standings.forEach((team, index) => {
                const row = document.createElement('tr');
                
                // Add position-based styling
                if (index === 0) row.classList.add('position-1');
                else if (index === 1) row.classList.add('position-2');
                else if (index === 2) row.classList.add('position-3');
                
                // Calculate position movement
                let movementIndicator = '';
                if (team.last_rank && team.rank !== team.last_rank) {
                    const movement = team.last_rank - team.rank;
                    if (movement > 0) {
                        movementIndicator = `<span class="position-movement movement-up">‚Üë${movement}</span>`;
                    } else {
                        movementIndicator = `<span class="position-movement movement-down">‚Üì${Math.abs(movement)}</span>`;
                    }
                } else if (team.last_rank) {
                    movementIndicator = `<span class="position-movement movement-same">-</span>`;
                }
                
                row.innerHTML = `
                    <td>${team.rank}${movementIndicator}</td>
                    <td>${team.player_name}</td>
                    <td>${team.entry_name}</td>
                    <td>${team.event_total}</td>
                    <td>${team.total.toLocaleString()}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Show the table
            tableElement.style.display = 'table';
        }

        // Function to show error message
        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, fetching FPL data...');
            
            // Fetch data
            fetchGameweekInfo();
            fetchLeagueStandings();
            
            // Set up auto-refresh every 5 minutes
            setInterval(() => {
                console.log('Refreshing league data...');
                fetchLeagueStandings();
            }, 300000);
        });
    </script>
</body>

</html>
