<!DOCTYPE html>
<html lang="no">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Oversikt over mÃ¥nedens bursdager med tilgjengelig design og navigasjon">
    <meta name="keywords" content="bursdag, gratulasjon, tilgjengelighet, wcag">
    <meta name="author" content="LÃ¸pegruppen">
    <title>MÃ¥nedens Bursdager - Tilgjengelig Oversikt</title>
    <link rel="icon" type="image/svg+xml" href="../assets/images/birthday-favicon.svg?v=1">
    <link rel="shortcut icon" type="image/svg+xml" href="../assets/images/birthday-favicon.svg?v=1">
    <link rel="apple-touch-icon" href="../assets/images/birthday-favicon.svg?v=1">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #FEF2E5;
            min-height: 100vh;
            color: #333;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Respect user's motion preferences */
        @media (prefers-reduced-motion: reduce) {
            .name-tag {
                transition: none;
            }
        }

        .main-container {
            text-align: center;
            max-width: 900px;
            width: 100%;
            background: #E3DEEC;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            border-bottom: 3px solid #FEF2E5;
            padding-bottom: 10px;
        }



        .birthday-container {
            flex: 1;
            overflow: hidden;
            margin-bottom: 20px;
            padding: 15px;
            background: #FEF2E5;
            border-radius: 12px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .birthday-scroll-area {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.3) rgba(0, 0, 0, 0.1);
        }

        .birthday-scroll-area:focus {
            outline: 2px solid #333;
            outline-offset: 2px;
        }

        .birthday-week-row {
            margin-bottom: 15px;
            background: #E3DEEC;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .week-header {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 15px;
            background: #FEF2E5;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            min-width: 80px;
        }

        .week-dates {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex: 1;
        }

        .date-column {
            background: #FEF2E5;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            min-width: 120px;
            flex: 1;
        }

        .birthday-date-group {
            margin-bottom: 6px;
            background: #FEF2E5;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .date-header {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            text-align: left;
            border-bottom: 2px solid #E3DEEC;
            padding-bottom: 4px;
        }

        .names-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: flex-start;
        }

        .name-tag {
            background: #E3DEEC;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            text-align: center;
            cursor: default;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .name-tag:hover,
        .name-tag:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #333;
            outline: none;
        }

        .name-tag:nth-child(3n+1) {
            background: linear-gradient(135deg, #E3DEEC 0%, #d4c8d8 100%);
        }

        .name-tag:nth-child(3n+2) {
            background: linear-gradient(135deg, #E3DEEC 0%, #d8d1e0 100%);
        }

        .name-tag:nth-child(3n+3) {
            background: linear-gradient(135deg, #E3DEEC 0%, #ddd5e3 100%);
        }

        .footer-message {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
            margin-top: 20px;
            text-align: center;
        }



        .no-birthdays {
            font-size: 1.5rem;
            color: #666;
            text-align: center;
            padding: 40px;
            font-style: italic;
        }

        /* Skip to content link for keyboard navigation */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #333;
            color: #fff;
            padding: 8px 12px;
            text-decoration: none;
            z-index: 1000;
            border-radius: 4px;
            font-weight: bold;
            transition: top 0.2s ease;
        }

        .skip-to-content:focus {
            top: 6px;
            outline: 2px solid #E3DEEC;
        }

        /* Scrollbar styling for birthday container */
        .birthday-container::-webkit-scrollbar {
            width: 8px;
        }

        .birthday-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }

        .birthday-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .birthday-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus management */
        *:focus {
            outline: 2px solid #333;
            outline-offset: 2px;
        }

        .name-tag:focus {
            outline: 3px solid #333;
            outline-offset: 2px;
            z-index: 10;
            position: relative;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .main-container {
                background: #ffffff;
                border: 3px solid #000000;
            }
            
            .birthday-week-row {
                border: 2px solid #000000;
            }
            
            .name-tag {
                border: 2px solid #000000;
                background: #ffffff;
                color: #000000;
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .title {
                font-size: 1.8rem;
            }
            
            .main-container {
                padding: 16px;
                margin: 8px;
            }
            
            .birthday-container {
                max-height: 60vh;
                padding: 12px;
            }
            
            .birthday-week-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .week-header {
                min-width: auto;
                align-self: flex-start;
            }
            
            .week-dates {
                flex-direction: column;
            }
            
            .date-column {
                min-width: auto;
            }
            
            .date-header {
                font-size: 1.1rem;
            }
            
            .name-tag {
                font-size: 0.9rem;
                padding: 8px 12px;
                min-height: 44px; /* Touch target size */
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .footer-message {
                font-size: 1.3rem;
            }
        }

        /* Touch device improvements */
        @media (hover: none) and (pointer: coarse) {
            .name-tag {
                min-height: 44px;
                padding: 12px 16px;
            }
            
            .name-tag:hover {
                transform: none; /* Remove hover effects on touch devices */
            }
        }
    </style>
</head>

<body>
    <a href="#main-content" class="skip-to-content">Hopp til hovedinnhold</a>
    
    <main class="main-container" role="main" id="main-content">
        <h1 class="title" id="monthlyTitle">Hurra for dere, som fyller Ã¥r i september</h1>
        
        <section class="birthday-container" id="birthdayContainer" 
                 aria-label="Bursdagsliste for mÃ¥neden" 
                 role="region"
                 tabindex="0">
            <!-- Birthday groups will be inserted here by JavaScript -->
        </section>
        
        <footer class="footer-message" role="contentinfo" aria-label="Gratulasjon">
            <span aria-hidden="true">ðŸŽ‰</span> Gratulerer med dagen! <span aria-hidden="true">ðŸŽ‚</span>
        </footer>
    </main>

    <script>
        // Birthday data loaded from CSV file
        let birthdayData = [];

        // Load birthday data from CSV file
        async function loadBirthdayData() {
            try {
                const response = await fetch('../assets/data/birthdays.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                birthdayData = parseCSV(csvText);
                console.log(`Loaded ${birthdayData.length} birthdays from CSV file`);
                
                // Initialize the page after data is loaded
                initializePage();
            } catch (error) {
                console.error('Error loading birthday data:', error);
                // Fallback to sample data for demonstration
                birthdayData = [
                    { name: "Alistair Brown", date: 28, month: 2 },
                    { name: "Sample Person", date: 15, month: 9 }
                ];
                console.log('Using fallback sample data');
                initializePage();
            }
        }

        // Convert name to proper case (handle "FirstName SURNAME" format)
        function formatNameProperCase(name) {
            // Split the name into parts
            const nameParts = name.split(' ');
            
            return nameParts.map(part => {
                // Convert each part to proper case (first letter uppercase, rest lowercase)
                return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
            }).join(' ');
        }

        // Parse CSV text into birthday data array
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const birthdays = [];
            
            // Skip header row (index 0)
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (line.trim() === '') continue;
                
                // Parse CSV line (handle quoted fields)
                const columns = parseCSVLine(line);
                if (columns.length >= 2) {
                    const rawName = columns[0].replace(/"/g, '').trim();
                    const dateOfBirth = columns[1].replace(/"/g, '').trim();
                    
                    // Convert name to proper case
                    const name = formatNameProperCase(rawName);
                    
                    // Parse date format DD.MM.YYYY
                    const dateParts = dateOfBirth.split('.');
                    if (dateParts.length === 3) {
                        const day = parseInt(dateParts[0]);
                        const month = parseInt(dateParts[1]);
                        
                        if (day >= 1 && day <= 31 && month >= 1 && month <= 12) {
                            birthdays.push({
                                name: name,
                                date: day,
                                month: month
                            });
                        }
                    }
                }
            }
            
            return birthdays;
        }

        // Simple CSV line parser that handles quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ';' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current); // Add the last field
            return result;
        }

        // Norwegian month names
        const norwegianMonths = [
            "januar", "februar", "mars", "april", "mai", "juni",
            "juli", "august", "september", "oktober", "november", "desember"
        ];

        // Get current month (1-12)
        function getCurrentMonth() {
            return new Date().getMonth() + 1;
        }

        // Update title with current month
        function updateTitle() {
            const currentMonth = getCurrentMonth();
            const monthName = norwegianMonths[currentMonth - 1];
            document.getElementById('monthlyTitle').textContent = 
                `Hurra for dere som fyller Ã¥r i ${monthName}!`;
        }

        // ISO week calculation functions
        function getISOWeek(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            // Thursday in current week decides the year
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            // January 4 is always in week 1
            const week1 = new Date(d.getFullYear(), 0, 4);
            // Adjust to Thursday in week 1 and count weeks from there
            return 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        function getWeekDateRange(year, month, weekNumber) {
            // Find all dates in the month that belong to this week
            const weekDates = [];
            for (let day = 1; day <= 31; day++) {
                const testDate = new Date(year, month - 1, day);
                if (testDate.getMonth() !== month - 1) break; // End of month
                
                if (getISOWeek(testDate) === weekNumber) {
                    weekDates.push(day);
                }
            }
            
            return weekDates;
        }

        // Get birthdays for current month grouped by ISO week, then by date
        function getCurrentMonthBirthdays() {
            const currentMonth = getCurrentMonth();
            const currentYear = new Date().getFullYear();
            const monthlyBirthdays = birthdayData.filter(person => person.month === currentMonth);
            
            // Group by ISO week first
            const groupedByWeek = {};
            monthlyBirthdays.forEach(person => {
                const personDate = new Date(currentYear, currentMonth - 1, person.date);
                const weekNumber = getISOWeek(personDate);
                
                if (!groupedByWeek[weekNumber]) {
                    groupedByWeek[weekNumber] = {};
                }
                
                if (!groupedByWeek[weekNumber][person.date]) {
                    groupedByWeek[weekNumber][person.date] = [];
                }
                
                groupedByWeek[weekNumber][person.date].push(person);
            });
            
            // Convert to sorted array structure
            const sortedWeeks = Object.keys(groupedByWeek).sort((a, b) => parseInt(a) - parseInt(b));
            return sortedWeeks.map(weekNumber => {
                const weekData = groupedByWeek[weekNumber];
                const sortedDates = Object.keys(weekData).sort((a, b) => parseInt(a) - parseInt(b));
                
                return {
                    week: parseInt(weekNumber),
                    dates: sortedDates.map(date => ({
                        date: parseInt(date),
                        people: weekData[date].sort((a, b) => a.name.localeCompare(b.name))
                    }))
                };
            });
        }

        // Format date for display
        function formatDate(date) {
            return `${date}. september`; // Will be updated dynamically
        }

        // Format date with current month name
        function formatDateWithMonth(date) {
            const currentMonth = getCurrentMonth();
            const monthName = norwegianMonths[currentMonth - 1];
            return `${date}. ${monthName}`;
        }

        // Render birthday groups by week (rows) and dates (columns)
        function renderBirthdays() {
            const birthdayContainer = document.getElementById('birthdayContainer');
            const weekGroups = getCurrentMonthBirthdays();
            const currentMonth = getCurrentMonth();
            const monthName = norwegianMonths[currentMonth - 1];

            if (weekGroups.length === 0) {
                birthdayContainer.innerHTML = `
                    <div class="no-birthdays" role="status" aria-live="polite">
                        Ingen bursdager denne mÃ¥neden <span aria-hidden="true">ðŸŽˆ</span>
                    </div>
                `;
                birthdayContainer.setAttribute('aria-label', `Ingen bursdager i ${monthName}`);
                return;
            }

            // Calculate total number of people with birthdays
            const totalPeople = weekGroups.reduce((total, week) => 
                total + week.dates.reduce((weekTotal, date) => weekTotal + date.people.length, 0), 0);

            const birthdayHTML = weekGroups.map((weekGroup, weekIndex) => {
                const dateColumnsHTML = weekGroup.dates.map((dateGroup, dateIndex) => {
                    const nameTagsHTML = dateGroup.people.map((person, personIndex) => 
                        `<span class="name-tag" 
                               role="listitem" 
                               tabindex="0"
                               aria-label="${person.name}, bursdag ${dateGroup.date}. ${monthName}">${person.name}</span>`
                    ).join('');

                    return `
                        <div class="date-column" role="group" aria-labelledby="date-${weekIndex}-${dateIndex}">
                            <h3 class="date-header" id="date-${weekIndex}-${dateIndex}">${dateGroup.date}. ${monthName}</h3>
                            <div class="names-list" role="list" aria-label="${dateGroup.people.length} person${dateGroup.people.length !== 1 ? 'er' : ''} har bursdag">
                                ${nameTagsHTML}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <section class="birthday-week-row" role="group" aria-labelledby="week-${weekIndex}">
                        <h2 class="week-header" id="week-${weekIndex}">
                            Uke ${weekGroup.week}
                        </h2>
                        <div class="week-dates" role="group">
                            ${dateColumnsHTML}
                        </div>
                    </section>
                `;
            }).join('');

            birthdayContainer.innerHTML = birthdayHTML;
            birthdayContainer.setAttribute('aria-label', `${totalPeople} person${totalPeople !== 1 ? 'er' : ''} har bursdag i ${monthName}`);
            
            // Announce to screen readers that content has been updated
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.className = 'sr-only';
            announcement.textContent = `Bursdagsliste oppdatert. ${totalPeople} person${totalPeople !== 1 ? 'er' : ''} har bursdag i ${monthName}.`;
            document.body.appendChild(announcement);
            
            setTimeout(() => {
                document.body.removeChild(announcement);
            }, 1000);
        }

        // Initialize the page after data is loaded
        function initializePage() {
            updateTitle();
            renderBirthdays();
            
            // Update every hour to catch month changes
            setInterval(() => {
                updateTitle();
                renderBirthdays();
            }, 60 * 60 * 1000);
        }

        // Start loading data when page loads
        document.addEventListener('DOMContentLoaded', loadBirthdayData);
    </script>
</body>

</html>
